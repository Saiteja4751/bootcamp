version: 2.1

jobs:
  packer-gcp-build:
    docker:
      - image: cimg/base:stable
    environment:
      VAULT_ADDR: http://127.0.0.1:8200
      VAULT_TOKEN: root
    steps:
      - checkout

      # ----------------------------
      # Install system dependencies
      # ----------------------------
      - run:
          name: Install system packages
          command: |
            sudo apt-get update
            sudo apt-get install -y \
              curl unzip gnupg lsb-release jq python3-pip

      # ----------------------------
      # Install gcloud SDK
      # ----------------------------
      - run:
          name: Install gcloud SDK
          command: |
            sudo apt-get update
            sudo apt-get install -y apt-transport-https ca-certificates gnupg
            echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] http://packages.cloud.google.com/apt cloud-sdk main" | \
              sudo tee /etc/apt/sources.list.d/google-cloud-sdk.list
            curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | \
              sudo gpg --dearmor -o /usr/share/keyrings/cloud.google.gpg
            sudo apt-get update
            sudo apt-get install -y google-cloud-cli
            gcloud version

      # ----------------------------
      # Authenticate to GCP
      # ----------------------------
      - run:
          name: Authenticate to Google Cloud
          command: |
            echo "$GCP_SA_KEY" > gcp-key.json
            gcloud auth activate-service-account --key-file=gcp-key.json
            gcloud auth list

      # ----------------------------
      # Install Ansible dependencies
      # ----------------------------
      - run:
          name: Install Ansible deps
          command: |
            pip3 install ansible passlib

      # ----------------------------
      # Install Packer & Vault
      # ----------------------------
      - run:
          name: Install Packer & Vault
          command: |
            # Install packer via apt
            curl -fsSL https://apt.releases.hashicorp.com/gpg | \
              sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg

            echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] \
              https://apt.releases.hashicorp.com $(lsb_release -cs) main" | \
              sudo tee /etc/apt/sources.list.d/hashicorp.list

            sudo apt-get update
            sudo apt-get install -y packer unzip

            # Install vault via binary (recommended)
            VAULT_VERSION="1.15.5"
            curl -fsSL https://releases.hashicorp.com/vault/${VAULT_VERSION}/vault_${VAULT_VERSION}_linux_amd64.zip -o vault.zip
            unzip vault.zip
            sudo mv vault /usr/local/bin/
            vault version

      # ----------------------------
      # Start Vault (dev mode)
      # ----------------------------
      - run:
          name: Start Vault
          command: |
            vault server -dev -dev-root-token-id=root > vault.log 2>&1 &
            sleep 5

      # ----------------------------
      # Configure Vault secrets
      # ----------------------------
      - run:
          name: Configure Vault Secrets
          command: |
            vault kv put secret/packer/ansible \
              admin_password="$ADMIN_PASSWORD" \
              user1_password="$USER1_PASSWORD"

      # ----------------------------
      # Create Packer vars file
      # ----------------------------
      - run:
          name: Create Packer vars from Vault
          command: |
            ADMIN_PASSWORD=$(vault kv get -field=admin_password secret/packer/ansible)
            USER1_PASSWORD=$(vault kv get -field=user1_password secret/packer/ansible)

            cat \<<EOF > packer_template_gcp/secrets.auto.pkrvars.hcl
            admin_password = "${ADMIN_PASSWORD}"
            user1_password = "${USER1_PASSWORD}"
            EOF

      - run:
          name: Debug Packer Directory
          command: |
            echo "Current directory:"
            pwd
            echo "Repo contents:"
            ls -la
            echo "Packer template contents:"
            ls -la ./packer_template_gcp
            echo "Packer version:"
            packer version
      # ----------------------------
      # Packer Init & Validate
      # ----------------------------
      # - run:
      #     name: Packer Init
      #     command: |
      #       cd packer_template_gcp
      #       ls -lart
      #       packer init .

      - run:
          name: Packer Validate
          command: |
            cd packer_template_gcp
            ls -lart
            packer fmt gcp-ubuntu.pkr.hcl
            packer validate gcp-ubuntu.pkr.hcl

          

      # ----------------------------
      # Packer Build
      # ----------------------------
      - run:
          name: Packer Build
          command: |
            packer build ./packer_template_gcp | tee packer.log
            IMAGE_NAME=$(grep -oP "project: \Kpacker-[^ ]+" packer.log | tail -1)
            echo "export IMAGE_NAME=$IMAGE_NAME" >> $BASH_ENV

workflows:
  version: 2
  packer-workflow:
    jobs:
      - packer-gcp-build
