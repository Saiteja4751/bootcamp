version: 2.1

jobs:
  packer-gcp-build:
    docker:
      - image: cimg/base:stable
    environment:
      VAULT_ADDR: http://127.0.0.1:8200
      VAULT_TOKEN: root
    steps:
      - checkout

      # ----------------------------
      # Install system dependencies
      # ----------------------------
      - run:
          name: Install system packages
          command: |
            sudo apt-get update
            sudo apt-get install -y \
              curl unzip gnupg lsb-release jq python3-pip

      # ----------------------------
      # Install gcloud SDK
      # ----------------------------
      - run:
          name: Install gcloud SDK
          command: |
            curl -sSL https://sdk.cloud.google.com | bash
            echo 'source $HOME/google-cloud-sdk/path.bash.inc' >> $BASH_ENV
            source $BASH_ENV
            gcloud version

      # ----------------------------
      # Authenticate to GCP
      # ----------------------------
      - run:
          name: Authenticate to Google Cloud
          command: |
            echo "$GCP_SA_KEY" > gcp-key.json
            gcloud auth activate-service-account --key-file=gcp-key.json
            gcloud auth list

      # ----------------------------
      # Install Ansible dependencies
      # ----------------------------
      - run:
          name: Install Ansible deps
          command: |
            pip3 install ansible passlib

      # ----------------------------
      # Install Packer & Vault
      # ----------------------------
      - run:
          name: Install Packer & Vault
          command: |
            curl -fsSL https://apt.releases.hashicorp.com/gpg | \
              sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg

            echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] \
              https://apt.releases.hashicorp.com $(lsb_release -cs) main" | \
              sudo tee /etc/apt/sources.list.d/hashicorp.list

            sudo apt-get update
            sudo apt-get install -y packer vault

      # ----------------------------
      # Start Vault (dev mode)
      # ----------------------------
      - run:
          name: Start Vault
          command: |
            vault server -dev -dev-root-token-id=root > vault.log 2>&1 &
            sleep 5

      # ----------------------------
      # Configure Vault secrets
      # ----------------------------
      - run:
          name: Configure Vault Secrets
          command: |
            vault kv put secret/packer/ansible \
              admin_password="$ADMIN_PASSWORD" \
              user1_password="$USER1_PASSWORD"

      # ----------------------------
      # Create Packer vars file
      # ----------------------------
      - run:
          name: Create Packer vars from Vault
          command: |
            ADMIN_PASSWORD=$(vault kv get -field=admin_password secret/packer/ansible)
            USER1_PASSWORD=$(vault kv get -field=user1_password secret/packer/ansible)

            cat <<EOF > packer_template_gcp/secrets.auto.pkrvars.hcl
            admin_password = "${ADMIN_PASSWORD}"
            user1_password = "${USER1_PASSWORD}"
            EOF

      # ----------------------------
      # Packer Init & Validate
      # ----------------------------
      - run:
          name: Packer Init
          command: packer init packer_template_gcp

      - run:
          name: Packer Validate
          command: packer validate packer_template_gcp

      # ----------------------------
      # Packer Build
      # ----------------------------
      - run:
          name: Packer Build
          command: |
            packer build packer_template_gcp | tee packer.log
            IMAGE_NAME=$(grep -oP "project: \Kpacker-[^ ]+" packer.log | tail -1)
            echo "export IMAGE_NAME=$IMAGE_NAME" >> $BASH_ENV

workflows:
  version: 2
  packer-workflow:
    jobs:
      - packer-gcp-build
