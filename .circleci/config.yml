version: 2.1
 
jobs:
 
  packer-gcp-build:
    docker:
      - image: cimg/base:stable
 
    environment:
      VAULT_ADDR: http://127.0.0.1:8200
      VAULT_TOKEN: root
 
    steps:
      - checkout
      
      - run:
          name: Install system packages
          command: |
            sudo apt-get update
            sudo apt-get install -y \
              curl unzip gnupg lsb-release jq python3-pip
 
      - run:
          name: Install Ansible deps
          command: |
            pip3 install ansible passlib
 
 
      - run:
          name: Install Packer & Vault
          command: |
            PACKER_VERSION="1.10.0"
            VAULT_VERSION="1.15.4"
 
            curl -fsSL https://releases.hashicorp.com/packer/${PACKER_VERSION}/packer_${PACKER_VERSION}_linux_amd64.zip -o packer.zip
            unzip packer.zip
            sudo mv packer /usr/local/bin/
 
            curl -fsSL https://releases.hashicorp.com/vault/${VAULT_VERSION}/vault_${VAULT_VERSION}_linux_amd64.zip -o vault.zip
            unzip vault.zip
            sudo mv vault /usr/local/bin/
 
            packer --version
            vault --version
 
 
      - run:
          name: Start Vault
          command: |
            vault server -dev -dev-root-token-id=root > vault.log 2>&1 &
            sleep 5
            vault status
 
 
      - run:
          name: Configure Vault Secrets
          command: |
            vault kv put secret/packer/ansible \
              admin_password="$ADMIN_PASSWORD" \
              user1_password="$USER1_PASSWORD"
 
      - run:
          name: Create Packer vars
          command: |
            ADMIN_PASSWORD=$(vault kv get -field=admin_password secret/packer/ansible)
            USER1_PASSWORD=$(vault kv get -field=user1_password secret/packer/ansible)
 
            echo "admin_password = \"${ADMIN_PASSWORD}\"" > packer_template_gcp/secrets.auto.pkrvars.hcl
            echo "user1_password = \"${USER1_PASSWORD}\"" >> packer_template_gcp/secrets.auto.pkrvars.hcl
 
            chmod 600 packer_template_gcp/secrets.auto.pkrvars.hcl
 
      - run:
          name: Create GCP credentials
          command: |
            echo "$GCP_SA_KEY" > gcp-key.json
            chmod 600 gcp-key.json
 
      - run:
          name: Packer Init
          command: packer init packer_template_gcp
 
      - run:
          name: Packer Validate
          environment:
            GOOGLE_APPLICATION_CREDENTIALS: /home/circleci/project/gcp-key.json
          command: packer validate packer_template_gcp
 
      # -----------------------------
      # Packer Build & Capture Image
      # -----------------------------
      - run:
          name: Packer Build
          environment:
            GOOGLE_APPLICATION_CREDENTIALS: /home/circleci/project/gcp-key.json
          command: |
            packer build packer_template_gcp | tee packer.log
 
            IMAGE_NAME=$(grep -oP "packer-[^ ]+" packer.log | tail -1)
 
            if [ -z "$IMAGE_NAME" ]; then
              echo "Image name not found"
              exit 1
            fi
 
            echo "export IMAGE_NAME=$IMAGE_NAME" >> $BASH_ENV
 
      - run:
          name: Show Image Name
          command: |
            source $BASH_ENV
            echo "Built Image: $IMAGE_NAME"

workflows:
  version: 2

  packer-terraform-workflow:
    jobs:
      - packer-gcp-build:
          filters:
            branches:
              only: main
